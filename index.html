<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول - لوحة تحكم المهندس المعماري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #8B5CF6;
            --secondary: #EC4899;
            --dark: #0f172a;
            --darker: #0a1120;
            --light: #e2e8f0;
            --gray: #94a3b8;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, #1e293b 50%, var(--dark) 100%);
            min-height: 100vh;
            color: var(--light);
        }
        
        .auth-container {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .loading {
            display: none;
        }
        
        .loading.show {
            display: inline-block;
        }
        
        .error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        
        .success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid #22c55e;
            color: #86efac;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: var(--light);
        }
        
        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="auth-container rounded-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl mb-4">
                    <i class="fas fa-key text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">تسجيل الدخول</h1>
                <p class="text-gray-400">أدخل مفتاح الوصول للمتابعة</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="accessKey" class="block text-sm font-medium text-gray-300 mb-2">
                        مفتاح الوصول
                    </label>
                    <input 
                        type="password" 
                        id="accessKey" 
                        name="accessKey"
                        class="input-field w-full px-4 py-3 rounded-lg focus:outline-none"
                        placeholder="أدخل مفتاح الوصول"
                        required
                    >
                </div>
                
                <div id="errorMessage" class="error p-3 rounded-lg hidden">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="errorText">مفتاح الوصول غير صحيح</span>
                </div>
                
                <div id="successMessage" class="success p-3 rounded-lg hidden">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>تم التحقق بنجاح! جاري التحويل...</span>
                </div>
                
                <button 
                    type="submit" 
                    id="loginBtn"
                    class="btn-primary w-full py-3 px-4 rounded-lg font-semibold text-white flex items-center justify-center"
                >
                    <span id="loginBtnText">دخول</span>
                    <i id="loginSpinner" class="fas fa-spinner fa-spin mr-2 loading"></i>
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-400 text-sm">
                    <i class="fas fa-shield-alt mr-1"></i>
                    محمي بنظام التحقق المتقدم
                </p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden Initially) -->
    <div id="mainApp" style="display: none;">
        <!-- ADD YOUR ORIGINAL APPLICATION CODE HERE -->
        <!-- Remove the <html>, <head>, and <body> tags from your original file -->
        <!-- Just copy everything from inside the <body> tag -->
        
        <!-- For now, showing a success message with logout button -->
        <div class="min-h-screen bg-gradient-to-br from-sky-50 via-indigo-50 to-purple-50 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                    <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">مرحباً بك!</h1>
                    <p class="text-gray-600 mb-6">تم تسجيل دخولك بنجاح إلى لوحة تحكم المهندس المعماري</p>
                    <p class="text-sm text-gray-500 mb-4">يرجى استبدال هذا المحتوى بالتطبيق الأصلي الخاص بك</p>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-sign-out-alt mr-2"></i>تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Replace with your Google Apps Script Web App URL
        const GOOGLE_SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
        
        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const accessKeyInput = document.getElementById('accessKey');
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginSpinner = document.getElementById('loginSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const errorText = document.getElementById('errorText');

        // Check if user is already authenticated
        window.addEventListener('load', () => {
            const isAuthenticated = sessionStorage.getItem('authenticated');
            if (isAuthenticated === 'true') {
                showMainApp();
            }
        });

        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const accessKey = accessKeyInput.value.trim();
            if (!accessKey) {
                showError('يرجى إدخال مفتاح الوصول');
                return;
            }

            setLoading(true);
            hideMessages();

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'validateKey',
                        key: accessKey,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        ip: await getUserIP()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess();
                    sessionStorage.setItem('authenticated', 'true');
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                } else {
                    showError(result.message || 'مفتاح الوصول غير صحيح');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showError('حدث خطأ أثناء التحقق. يرجى المحاولة مرة أخرى.');
            } finally {
                setLoading(false);
            }
        });

        // Helper functions
        function setLoading(loading) {
            loginBtn.disabled = loading;
            if (loading) {
                loginBtnText.textContent = 'جاري التحقق...';
                loginSpinner.classList.add('show');
            } else {
                loginBtnText.textContent = 'دخول';
                loginSpinner.classList.remove('show');
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        function showSuccess() {
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }

        function showMainApp() {
            loginPage.style.display = 'none';
            mainApp.style.display = 'block';
        }

        function logout() {
            sessionStorage.removeItem('authenticated');
            mainApp.style.display = 'none';
            loginPage.style.display = 'block';
            accessKeyInput.value = '';
            hideMessages();
        }

        // Get user IP (optional, for logging purposes)
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Unknown';
            }
        }

        // Prevent back button after authentication
        window.addEventListener('popstate', () => {
            if (sessionStorage.getItem('authenticated') === 'true') {
                history.pushState(null, null, location.href);
            }
        });
    </script>
</body>
</html>
